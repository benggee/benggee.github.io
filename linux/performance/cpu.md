# cpu性能优化

## cpu平衡负载

单位时间里的活跃进程数，包含了可运行状态和不可中断状态的平均进程数，一般认为平均进程数和cpu的个数保持一致是最理想状态。

### 查看cpu核数

```bash
$ grep 'model name' /proc/cpuinfo | wc -l
```



### 平均负载和cpu使用率

- CPU密集开，平均负载和CPU使用率是一致的
- I/O密集型，等待I/O会产生不可中断进程，此时平均负载升高，CPU使用率不一定很高
- 大量等待CPU的进程调度也会导致平均负载升高，此时CPU使用率也会比较高



## 模拟实验

我们模拟CPU密集型、I/O密集型、和大量进程的场景分别来看CPU的使用情况。

### 工具：

```bash
$ yum stress sysstat -y
```

stress   linux压测工具

sysstat    包含mpstat和pidstat， mpstat是多核分析工具，来用实时查看每个CPU的使用情况。pidstat是一个进程分析工具，实时查看进程的CPU、I/O、内存以及上下文切换指标



### 实验一：CPU密集型

```bash
# 一个CPU使用率100%
$ stress --cpu 1 --timeout 600 
```

```bash
# -d 表示高亮变化的部分
$ watch -d uptime 
 17:19:32 up 133 days, 19:03,  3 users,  load average: 0.01, 2.46, 3.58
```

查看CPU使用率变化情况

```bash
# -P ALL 表示监控所有CPU, 5表示5秒刷新一次
$ mpstat -P ALL 5
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:25:48 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:25:53 PM  all   50.15    0.00    0.30    0.00    0.20    0.00    0.00    0.00    0.00   49.35
05:25:53 PM    0   99.60    0.00    0.00    0.00    0.40    0.00    0.00    0.00    0.00    0.00
05:25:53 PM    1    0.60    0.00    0.60    0.00    0.00    0.00    0.00    0.00    0.00   98.80
```

找出使用率高的进程

```bash
# 隔5秒输出结果,输出1次
$ pidstat -u 5 1 
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:26:15 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
05:26:20 PM     0    114567    0.20    0.00    0.00    0.00    0.20     0  tuned
05:26:20 PM   989    178452    0.00    0.20    0.00    0.00    0.20     0  mysqld
05:26:20 PM     0   3115279    0.40    0.20    0.00    0.00    0.60     1  hosteye
05:26:20 PM     0   3116185   99.60    0.00    0.00    0.00   99.60     0  stress
```



### 实验二：I/O密集型

```bash
$ stress -i 1 --timeout 600
```

```bash
# -d 表示高亮变化的部分
$ watch -d uptime 
17:28:31 up 133 days, 19:12,  3 users,  load average: 1.28, 1.00, 2.22
```

查看CPU使用情况

```bash
$ mpstat -P ALL 5 
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:31:21 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:31:26 PM  all    1.80    0.00   48.50    0.40    0.30    0.10    0.00    0.00    0.00   48.90
05:31:26 PM    0    2.00    0.00   94.80    0.00    0.40    0.00    0.00    0.00    0.00    2.80
05:31:26 PM    1    1.60    0.00    2.20    0.80    0.20    0.20    0.00    0.00    0.00   95.00
```

查看是哪个进程导致的

```bash
$ pidstat -u 5 1
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:32:26 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
05:32:31 PM     0       462    0.00    0.20    0.00    0.00    0.20     0  jbd2/vda1-8
05:32:31 PM     0      1272    0.00    0.20    0.00    0.00    0.20     1  bcm-agent
05:32:31 PM   989    178452    0.00    0.20    0.00    0.00    0.20     1  mysqld
05:32:31 PM     0   3115279    0.80    0.20    0.00    0.00    1.00     1  hosteye
05:32:31 PM     0   3116697    1.60   97.01    0.00    0.20   98.60     0  stress
```



### 实验三：大量进程

```bash
$ stress -c 10 --timeout 600
```

```bash
$ watch -d uptime
 17:33:48 up 133 days, 19:17,  3 users,  load average: 5.25, 2.16, 2.25
```

查看CPU使用情况

```bash
$ mpstat -P ALL 5
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:34:11 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
05:34:16 PM  all   99.50    0.00    0.10    0.00    0.40    0.00    0.00    0.00    0.00    0.00
05:34:16 PM    0   99.60    0.00    0.00    0.00    0.40    0.00    0.00    0.00    0.00    0.00
05:34:16 PM    1   99.40    0.00    0.20    0.00    0.40    0.00    0.00    0.00    0.00    0.00
```

查看是哪个进程导致的

```bash
$ pidstat -u 5 1
Linux 4.18.0-193.6.3.el8_2.x86_64 (seepre) 	04/19/2021 	_x86_64_	(2 CPU)

05:34:53 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
05:34:58 PM     0      1272    0.00    0.20    0.00    0.00    0.20     1  bcm-agent
05:34:58 PM   989    178452    0.00    0.20    0.00    0.00    0.20     1  mysqld
05:34:58 PM     0   3113781    0.20    0.00    0.00    0.40    0.20     0  watch
05:34:58 PM     0   3116889   19.76    0.00    0.00   79.24   19.76     0  stress
05:34:58 PM     0   3116890   19.76    0.00    0.00   79.44   19.76     1  stress
05:34:58 PM     0   3116891   19.76    0.00    0.00   80.24   19.76     1  stress
05:34:58 PM     0   3116892   19.96    0.00    0.00   80.84   19.96     0  stress
05:34:58 PM     0   3116893   19.96    0.00    0.00   79.64   19.96     1  stress
05:34:58 PM     0   3116894   19.96    0.00    0.00   80.04   19.96     0  stress
05:34:58 PM     0   3116895   19.76    0.00    0.00   80.44   19.76     1  stress
05:34:58 PM     0   3116896   19.76    0.00    0.00   79.44   19.76     0  stress
05:34:58 PM     0   3116897   19.56    0.00    0.00   80.24   19.56     1  stress
05:34:58 PM     0   3116898   19.76    0.00    0.00   80.04   19.76     0  stress
```

